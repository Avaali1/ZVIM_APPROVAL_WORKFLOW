sap.ui.define(["./BaseController","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/util/XMLHelper","sap/ui/core/Fragment","sap/m/MessageToast","sap/m/PDFViewer","sap/ui/unified/FileUploaderParameter","jquery.sap.global","sap/ui/core/Core"],function(e,t,s,o,i,a,r,n,l,d,u,h){"use strict";return e.extend("in.compass.vim.ZVIM_APPROVAL_WORKFLOW.controller.Main",{oInputModel:new s,oHeaderModel:new s,oItemModel:new s,oHistoryModel:new s,oDocModel:new s,oPDFModel:new s,oCommentModel:new s,onInit:function(e){this.sAPPRACT="";this.sNote="";this.docID="";this._aFullItemData=[];this.WIID=this.workItemId=this.getOwnerComponent().getComponentData().startupParameters.wfInstanceId[0];this._fragmentIds={};this._displayTable();this._displayHistory();this._displayDocument();this._displayComment();this.getView().setModel(this.oInputModel,"input");this.getView().setModel(this.oHeaderModel,"header");this.getView().setModel(this.oItemModel,"item");this.getView().setModel(this.oHistoryModel,"history");this.getView().setModel(this.oDocModel,"document");this.getView().setModel(this.oPDFModel,"pdf");this.getView().setModel(this.oCommentModel,"comment");if(sap.ushell.Container){this.LUser=sap.ushell.Container.getService("UserInfo").getId()}else{this.LUser="ABAP12"}},_onPageItem:function(e){const t=e.getSource().getText();if(t==="20"){var s=this.getView().getModel("item").getData();this.oItemModel.setSizeLimit(s.length>20?20:s.length);const e=new sap.ui.model.json.JSONModel(s.slice(0,20));this.getView().setModel(e,"item")}if(t==="50"){var s=this.getView().getModel("item").getData();const e=s.slice(0,50);this.oItemModel.setSizeLimit(s.length>50?50:s.length);const t=new sap.ui.model.json.JSONModel(s.slice(0,50));this.getView().setModel(t,"item")}if(t==="100"){var s=this.getView().getModel("item").getData();this.oItemModel.setSizeLimit(s.length>100?100:s.length);const e=new sap.ui.model.json.JSONModel(s.slice(0,100));this.getView().setModel(e,"item")}},onExit:function(e){this.oInputModel.destroy();this.oHeaderModel.destroy();this.oItemModel.destroy();this.oHistoryModel.destroy();this.oDocModel.destroy();this.oPDFModel.destroy();if(this._pdfDialog){this._pdfDialog.destroy()}},onAfterRendering:function(){let e=this},_onObjectMatched:function(){let e=this;this.workItemId=this.getOwnerComponent().getComponentData().startupParameters.wfInstanceId[0];this._loadWorkflowDetails(this.workItemId).then(function(e){this.oHeaderModel.setProperty("/",e.results)}.bind(this))},_loadWorkflowDetails:function(e){var t=this;return new Promise(function(t,s){let o={WIID:e};var i="/HeaderDataSet";var a=new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZVIM_APPR_INBOX_SRV");a.read("/HeaderDataSet",{filters:[o],urlParameters:{$expand:"HdrItmNav"},success:function(e,s){t(e,s)},error:function(e){s(e)}})}.bind(this))},_displayTable:function(){var e=this;var t={};t.results=[];var s=[new sap.ui.model.Filter("WIID","EQ",this.WIID)];var o="/HeaderDataSet";var i=new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZVIM_APPR_INBOX_SRV");sap.ui.core.BusyIndicator.show(true);i.read(o,{filters:s,urlParameters:{$expand:"HdrItmNav"},success:function(t){sap.ui.core.BusyIndicator.hide(true);if(t.results.length<=1){var s=t.results[0].HdrItmNav.results;e.docID=t.results[0].DOCID;e.oHeaderModel.setProperty("/",t.results[0]);e.oItemModel.setSizeLimit(s.length>20?20:s.length);e.oItemModel.setProperty("/",s);t.results.push({WIID:e.WIID})}var o=new sap.ui.model.json.JSONModel(t.results)},error:function(e){sap.ui.core.BusyIndicator.hide(true);sap.m.MessageBox.error(e.message,{title:"Error"})}})},_displayHistory:function(){var e=this;var t={};t.results=[];var s=[new sap.ui.model.Filter("WIID","EQ",this.WIID)];var o="/HeaderDataSet";var i=new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZVIM_APPR_INBOX_SRV");sap.ui.core.BusyIndicator.show(true);i.read(o,{filters:s,urlParameters:{$expand:"HdrHistNav"},success:function(t){sap.ui.core.BusyIndicator.hide(true);if(t.results.length<=1){var s=t.results[0].HdrHistNav.results;e.oHistoryModel.setSizeLimit(s.length>20?20:s.length);e.oHistoryModel.setProperty("/",s);t.results.push({WIID:e.WIID})}},error:function(e){sap.ui.core.BusyIndicator.hide(true);sap.m.MessageBox.error(e.message,{title:"Error"})}})},_displayDocument:function(){var e=this;var t={};t.results=[];var s=new sap.ui.model.Filter("DOCID","EQ",this.docID);var o=new sap.ui.model.Filter("WIID","EQ",this.WIID);var i="/HeaderDataSet";var a=new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZVIM_APPR_INBOX_SRV");sap.ui.core.BusyIndicator.show(true);a.read(i,{filters:[s,o],urlParameters:{$expand:"HdrAttchNav"},success:function(t){sap.ui.core.BusyIndicator.hide(true);if(t.results.length<=1){var s=t.results[0].HdrAttchNav.results;e.oDocModel.setProperty("/",s);t.results.push({WIID:e.WIID})}},error:function(e){sap.ui.core.BusyIndicator.hide(true);sap.m.MessageBox.error(e.message,{title:"Error"})}})},_displayComment:function(){var e=this;var t={};t.results=[];var s=new sap.ui.model.Filter("DOCID","EQ",this.docID);var o=new sap.ui.model.Filter("WIID","EQ",this.WIID);var i="/HeaderDataSet";var a=new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZVIM_APPR_INBOX_SRV");sap.ui.core.BusyIndicator.show(true);a.read(i,{filters:[s,o],urlParameters:{$expand:"HdrCommNav"},success:function(t){sap.ui.core.BusyIndicator.hide(true);if(t.results.length<=1){debugger;var s="";var o=t.results[0].HdrCommNav.results;for(var i=0;i<o.length;i++){s=s+"\n"+o[i].Comments;var a=s}e.byId("idText").setValue(a);e.oCommentModel.setProperty("/",a)}},error:function(e){sap.ui.core.BusyIndicator.hide(true);sap.m.MessageBox.error(e.message,{title:"Error"})}})},onCancelUpload:function(){this.pDialog.close()},onUpload:function(e){var t=this.getView().byId("fileUploader").getValue();if(!t){n.show("Please select a file to upload.");return}t.upload();n.show("File upload initiated.");this.pDialog.close()},onUploadComplete:function(e){const t=e.getParameter("responseRaw");if(t){e.getSource().setValue(null)}},onChangeFile:function(e){e.getSource().removeAllHeaderParameters();const t=new d({name:"x-csrf-token",value:this.getModel().getSecurityToken()});e.getSource().addHeaderParameter(t);const s=new d({name:"slug",value:e.getParameter("newValue")+","+this.workItemId+":"+this.docID+":"+"AP"});e.getSource().addHeaderParameter(s)},_onApprove:function(e){debugger;var t=this;if(e.getSource().getText()=="Approve"){this.sAPPRACT="AP";this._onOpenApproveDialog(e)}else{this.sAPPRACT="RJ";this._onOpenApproveDialog(e)}},_onOpenApproveDialog:function(e){debugger;var t=this;if(!this.pDialog){r.load({name:"in.compass.vim.ZVIM_APPROVAL_WORKFLOW.fragment.ApproveDialog",controller:this}).then(function(e){t._changeDialogValues();this.getView().addDependent(e);this.pDialog=e;this.pDialog.open()}.bind(this))}else{t._changeDialogValues();this.pDialog.open()}},_changeDialogValues:function(){debugger;if(this.sAPPRACT==="AP"){h.byId("decisionDialog").setTitle("Submit Decision");h.byId("lblapp").setText("Decision Note:")}if(this.sAPPRACT==="RJ"){h.byId("decisionDialog").setTitle("Reject");h.byId("lblapp").setText("Comment")}},_onOpenRejectDialog:function(e){},onAddDocument:function(e){if(!this.pDialog){r.load({name:"in.compass.vim.ZVIM_APPROVAL_WORKFLOW.fragment.UploadDoc",controller:this}).then(function(e){this.getView().addDependent(e);this.pDialog=e;this.pDialog.open()}.bind(this))}else{this.pDialog.open()}},onNoteLiveChange:function(e){this.sNote=e.getSource().getValue()},onSubmit:function(e){debugger;var t=this;if(this.sNote!==""||this.sNote!==" "){sap.m.MessageToast.show("Please Enter the Comment")}if(this.sNote!==""||this.sNote!==" "&&this.workItemId!==" "&&this.docID!==" "){const e={WIID:this.workItemId,DOCID:this.docID,APPRACT:this.sAPPRACT,COMMENTS:this.sNote};const s=new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZVIM_APPR_INBOX_SRV");const o="/ApprovalSet";s.create(o,e,{success:function(e,s){sap.m.MessageToast.show("Data posted successfully!");sap.ui.getCore().getEventBus().publish("sap.ui.core","InboxDataRefresh");t.getOwnerComponent().getModel().refresh()},error:function(e){sap.m.MessageBox.error("Error posting data.")}})}if(this.sNote!==""||this.sNote!==" "){h.byId("idText1").setValue(" ");this.pDialog.close()}},onCancel:function(e){debugger;h.byId("idText1").setValue(" ");this.pDialog.close()},onDialogAfterClose:function(e){h.byId("idText1").setValue(" ");this.pDialog.close()},_onPressDocument:function(e){debugger;var t=this.getView().getModel("document");var s=e.getSource().getParent().getBindingContextPath();var o=t.getProperty(s);var i=new sap.m.PDFViewer({source:"/sap/opu/odata/SAP/ZVIM_APPR_INBOX_SRV/AttchPDFSet(DOCID='"+o.DOCID+"',ARCH_DOC_ID='"+o.ARCH_DOC_ID+"')/$value",title:"PDF Document",isTrustedSource:"true"});this.getView().addDependent(i);i.open();if(this.oPDFViewer){this.oPDFViewer.close()}},onClosePDFDialog:function(){this.getView().setBusy(false);this._pdfDialog=null;this._pdfDialog.close()},_onPagehistory:function(e){const t=e.getSource().getText();if(t==="20"){debugger;var s=this.getView().getModel("history").getData();this.oHistoryModel.setSizeLimit(s.length>20?20:s.length);const e=new sap.ui.model.json.JSONModel(s.slice(0,20));this.getView().setModel(e,"history")}if(t==="50"){debugger;var s=this.getView().getModel("history").getData();this.oHistoryModel.setSizeLimit(s.length>50?s.length:50);const e=new sap.ui.model.json.JSONModel(s.slice(0,50));this.getView().setModel(e,"history")}if(t==="100"){debugger;var s=this.getView().getModel("history").getData();this.oHistoryModel.setSizeLimit(s.length>100?100:s.length);const e=new sap.ui.model.json.JSONModel(s.slice(0,100));this.getView().setModel(e,"history")}}})});